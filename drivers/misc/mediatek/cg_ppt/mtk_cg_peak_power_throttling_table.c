// SPDX-License-Identifier: GPL-2.0
/*
 * Copyright (c) 2023 MediaTek Inc.
 * Author: Clouds Lee <clouds.lee@mediatek.com>
 */

#include "mtk_cg_peak_power_throttling_table.h"


#if   defined(__KERNEL__)
/*
 * -----------------------------------------------
 * IP Peak Power Table
 * -----------------------------------------------
 */
struct ippeakpowertableDataRow
ip_peak_power_table[IP_PEAK_POWER_TABLE_IDX_ROW_COUNT]
__ppt_table_alignment__ = {
/* Freq(M)   Voltage(mV) Dyn pwr(mW) Power ratio (permille)*/
	/* PP_BCPU */ {3250, 1100, 5658, 711, 1210, 1210, 8, 10},
	/* PP_MCPU */ {2950, 1000, 11710, 578, 760, 760, 5, 15},
	/* PP_LCPU */ {2200, 850, 5286, 780, 780, 780, 8, 8},
	/* PP_DSU */ {1650, 1100, 1456, 667, 1720, 1720, 8, 10},
	/* PP_GPU Stack */ {1300, 815, 15635, 760, 760, 760, 4, 20},
	/* PP_GPU Top */ {1352, 831, 1527, 1044, 1044, 1044, 15, 4},
};
/*
 * -----------------------------------------------
 * Leakage Scale Table
 * -----------------------------------------------
 */
struct leakagescaletableDataRow
leakage_scale_table[LEAKAGE_SCALE_TABLE_IDX_ROW_COUNT]
__ppt_table_alignment__ = {
	/* tz4 */ {25, 62},
	/* tz3 */ {45, 130 },
	/* tz2 */ {65, 267 },
	/* tz1 */ {85, 527 },
	/* tz0 */ {105, 1000 },
};

/*
 * -----------------------------------------------
 * IP Peak Power Params (IpPeakPowerParams)
 * -----------------------------------------------
 */

/*
 * -----------------------------------------------
 * Peak Power Combo Table
 * -----------------------------------------------
 */

struct peakpowercombotableDataRow
peak_power_combo_table_gpu[GPU_PEAK_POWER_COMBO_TABLE_IDX_ROW_COUNT]
__ppt_table_alignment__ = {
	/* combo 0 */
	{1300, 1352, 2100, 2100, 1800, 1480,
	{859, 750, 0, 0, 0, 0, 0, 0, 0}, {902, 803, 0, 0, 0, 0, 0, 0, 0},
	{832, 778, 0, 0, 0, 0, 0, 0, 0}, {907, 822, 0, 0, 0, 0, 0, 0, 0},
	{967, 849, 0, 0, 0, 0, 0, 0, 0}, {864, 778, 0, 0, 0, 0, 0, 0, 0},
	0},
	/* combo 1 */
	{1248, 1352, 2100, 2100, 1800, 1480,
	{860, 754, 0, 0, 0, 0, 0, 0, 0}, {902, 803, 0, 0, 0, 0, 0, 0, 0},
	{832, 778, 0, 0, 0, 0, 0, 0, 0}, {907, 822, 0, 0, 0, 0, 0, 0, 0},
	{967, 849, 0, 0, 0, 0, 0, 0, 0}, {864, 778, 0, 0, 0, 0, 0, 0, 0},
	0},
	/* combo 2 */
	{1196, 1352, 2100, 2100, 1800, 1480,
	{862, 758, 0, 0, 0, 0, 0, 0, 0}, {902, 803, 0, 0, 0, 0, 0, 0, 0},
	{832, 778, 0, 0, 0, 0, 0, 0, 0}, {907, 822, 0, 0, 0, 0, 0, 0, 0},
	{967, 849, 0, 0, 0, 0, 0, 0, 0}, {864, 778, 0, 0, 0, 0, 0, 0, 0},
	0},
	/* combo 3 */
	{1144, 1352, 2100, 2100, 1800, 1480,
	{863, 763, 0, 0, 0, 0, 0, 0, 0}, {902, 803, 0, 0, 0, 0, 0, 0, 0},
	{832, 778, 0, 0, 0, 0, 0, 0, 0}, {907, 822, 0, 0, 0, 0, 0, 0, 0},
	{967, 849, 0, 0, 0, 0, 0, 0, 0}, {864, 778, 0, 0, 0, 0, 0, 0, 0},
	0},
	/* combo 4 */
	{1092, 1352, 2000, 2000, 1800, 1410,
	{865, 767, 0, 0, 0, 0, 0, 0, 0}, {902, 803, 0, 0, 0, 0, 0, 0, 0},
	{834, 783, 0, 0, 0, 0, 0, 0, 0}, {905, 829, 0, 0, 0, 0, 0, 0, 0},
	{967, 849, 0, 0, 0, 0, 0, 0, 0}, {862, 783, 0, 0, 0, 0, 0, 0, 0},
	0},
	/* combo 5 */
	{1040, 1352, 2000, 2000, 1700, 1410,
	{866, 771, 0, 0, 0, 0, 0, 0, 0}, {902, 803, 0, 0, 0, 0, 0, 0, 0},
	{834, 783, 0, 0, 0, 0, 0, 0, 0}, {905, 829, 0, 0, 0, 0, 0, 0, 0},
	{961, 850, 0, 0, 0, 0, 0, 0, 0}, {862, 783, 0, 0, 0, 0, 0, 0, 0},
	0},
	/* combo 6 */
	{988, 1352, 2000, 2000, 1700, 1410,
	{868, 776, 0, 0, 0, 0, 0, 0, 0}, {902, 803, 0, 0, 0, 0, 0, 0, 0},
	{834, 783, 0, 0, 0, 0, 0, 0, 0}, {905, 829, 0, 0, 0, 0, 0, 0, 0},
	{961, 850, 0, 0, 0, 0, 0, 0, 0}, {862, 783, 0, 0, 0, 0, 0, 0, 0},
	0},
	/* combo 7 */
	{910, 1352, 1900, 1900, 1600, 1340,
	{871, 786, 0, 0, 0, 0, 0, 0, 0}, {902, 803, 0, 0, 0, 0, 0, 0, 0},
	{841, 788, 0, 0, 0, 0, 0, 0, 0}, {911, 838, 0, 0, 0, 0, 0, 0, 0},
	{955, 851, 0, 0, 0, 0, 0, 0, 0}, {860, 788, 0, 0, 0, 0, 0, 0, 0},
	0},
	/* combo 8 */
	{806, 1352, 1800, 1800, 1600, 1270,
	{874, 792, 0, 0, 0, 0, 0, 0, 0}, {902, 803, 0, 0, 0, 0, 0, 0, 0},
	{840, 792, 0, 0, 0, 0, 0, 0, 0}, {917, 846, 0, 0, 0, 0, 0, 0, 0},
	{955, 851, 0, 0, 0, 0, 0, 0, 0}, {858, 792, 0, 0, 0, 0, 0, 0, 0},
	0},
	/* combo 9 */
	{702, 1352, 1700, 1700, 1500, 1200,
	{876, 812, 0, 0, 0, 0, 0, 0, 0}, {902, 803, 0, 0, 0, 0, 0, 0, 0},
	{839, 794, 0, 0, 0, 0, 0, 0, 0}, {917, 847, 0, 0, 0, 0, 0, 0, 0},
	{949, 853, 0, 0, 0, 0, 0, 0, 0}, {856, 794, 0, 0, 0, 0, 0, 0, 0},
	0},

};

struct peakpowercombotableDataRow
peak_power_combo_table_cpu[CPU_PEAK_POWER_COMBO_TABLE_IDX_ROW_COUNT]
__ppt_table_alignment__ = {
	/* combo 0 */
	{702, 1352, 3250, 2850, 2000, 1900,
	{876, 812, 0, 0, 0, 0, 0, 0, 0}, {902, 803, 0, 0, 0, 0, 0, 0, 0},
	{892, 741, 0, 0, 0, 0, 0, 0, 0}, {941, 805, 0, 0, 0, 0, 0, 0, 0},
	{968, 840, 0, 0, 0, 0, 0, 0, 0}, {871, 741, 0, 0, 0, 0, 0, 0, 0},
	0 },
	/* combo 1 */
	{702, 1352, 3100, 2850, 2000, 1900,
	{876, 812, 0, 0, 0, 0, 0, 0, 0}, {902, 803, 0, 0, 0, 0, 0, 0, 0},
	{868, 745, 0, 0, 0, 0, 0, 0, 0}, {941, 805, 0, 0, 0, 0, 0, 0, 0},
	{968, 840, 0, 0, 0, 0, 0, 0, 0}, {871, 745, 0, 0, 0, 0, 0, 0, 0},
	0 },
	/* combo 2 */
	{702, 1352, 2900, 2700, 2000, 1900,
	{876, 812, 0, 0, 0, 0, 0, 0, 0}, {902, 803, 0, 0, 0, 0, 0, 0, 0},
	{858, 750, 0, 0, 0, 0, 0, 0, 0}, {930, 809, 0, 0, 0, 0, 0, 0, 0},
	{968, 840, 0, 0, 0, 0, 0, 0, 0}, {871, 750, 0, 0, 0, 0, 0, 0, 0},
	0 },
	/* combo 3 */
	{702, 1352, 2800, 2500, 2000, 1900,
	{876, 812, 0, 0, 0, 0, 0, 0, 0}, {902, 803, 0, 0, 0, 0, 0, 0, 0},
	{853, 753, 0, 0, 0, 0, 0, 0, 0}, {920, 814, 0, 0, 0, 0, 0, 0, 0},
	{968, 840, 0, 0, 0, 0, 0, 0, 0}, {871, 753, 0, 0, 0, 0, 0, 0, 0},
	0 },
	/* combo 4 */
	{702, 1352, 2600, 2300, 2000, 1830,
	{876, 812, 0, 0, 0, 0, 0, 0, 0}, {902, 803, 0, 0, 0, 0, 0, 0, 0},
	{844, 758, 0, 0, 0, 0, 0, 0, 0}, {912, 818, 0, 0, 0, 0, 0, 0, 0},
	{968, 840, 0, 0, 0, 0, 0, 0, 0}, {870, 758, 0, 0, 0, 0, 0, 0, 0},
	0 },
	/* combo 5 */
	{702, 1352, 2400, 2100, 2000, 1690,
	{876, 812, 0, 0, 0, 0, 0, 0, 0}, {902, 803, 0, 0, 0, 0, 0, 0, 0},
	{836, 770, 0, 0, 0, 0, 0, 0, 0}, {907, 822, 0, 0, 0, 0, 0, 0, 0},
	{968, 840, 0, 0, 0, 0, 0, 0, 0}, {868, 770, 0, 0, 0, 0, 0, 0, 0},
	0 },
	/* combo 6 */
	{702, 1352, 2200, 1900, 2000, 1550,
	{876, 812, 0, 0, 0, 0, 0, 0, 0}, {902, 803, 0, 0, 0, 0, 0, 0, 0},
	{830, 777, 0, 0, 0, 0, 0, 0, 0}, {911, 838, 0, 0, 0, 0, 0, 0, 0},
	{968, 840, 0, 0, 0, 0, 0, 0, 0}, {865, 777, 0, 0, 0, 0, 0, 0, 0},
	0 },
	/* combo 7 */
	{702, 1352, 2000, 1600, 2000, 1410,
	{876, 812, 0, 0, 0, 0, 0, 0, 0}, {902, 803, 0, 0, 0, 0, 0, 0, 0},
	{834, 783, 0, 0, 0, 0, 0, 0, 0}, {919, 848, 0, 0, 0, 0, 0, 0, 0},
	{968, 840, 0, 0, 0, 0, 0, 0, 0}, {862, 783, 0, 0, 0, 0, 0, 0, 0},
	0 },
	/* combo 8 */
	{702, 1352, 1800, 1400, 1800, 1270,
	{876, 812, 0, 0, 0, 0, 0, 0, 0}, {902, 803, 0, 0, 0, 0, 0, 0, 0},
	{840, 792, 0, 0, 0, 0, 0, 0, 0}, {925, 849, 0, 0, 0, 0, 0, 0, 0},
	{967, 849, 0, 0, 0, 0, 0, 0, 0}, {858, 792, 0, 0, 0, 0, 0, 0, 0},
	0 },
	/* combo 9 */
	{702, 1352, 1600, 1100, 1600, 1130,
	{876, 812, 0, 0, 0, 0, 0, 0, 0}, {902, 803, 0, 0, 0, 0, 0, 0, 0},
	{842, 797, 0, 0, 0, 0, 0, 0, 0}, {939, 848, 0, 0, 0, 0, 0, 0, 0},
	{955, 851, 0, 0, 0, 0, 0, 0, 0}, {856, 797, 0, 0, 0, 0, 0, 0, 0},
	0},

};

#endif /*#if   defined(__KERNEL__)*/



/*
 * ========================================================
 * Helper Function
 * ========================================================
 */
void print_peak_power_combo_table(
	struct peakpowercombotableDataRow combo_table[],
	int count)
{
	pp_print("cg ppt table:\n");
	pp_print("  %-10s |    gs   |    gt   |    cb   |    cm   |    cl   |   cd   |      cpi\n",
			"Combo");
	for (int i = 0; i < count; i++) {
		pp_print(
			"  %-8s %d | %7d | %7d | %7d | %7d | %7d | %6d | %12d\n",
			"cmb   ", i, combo_table[i].gpustackfreq_m,
			combo_table[i].gputopfreq_m, combo_table[i].bcpufreq_m,
			combo_table[i].mcpufreq_m, combo_table[i].lcpufreq_m,
			combo_table[i].dsufreq_m,
			combo_table[i].combopeakpowerin_mw);
	}

	//IpPeakPowerParams
	pp_print("\ncg_ppt params table:\n");
	pp_print(
	"  %-10s |   dr   |  peff  |    v   |  lk1o5  |    dyn    |     lk    |    pwro     |   rl   |     pwri\n",
	"Part/Index");
	for (int i = 0; i < count; i++) {
		struct IpPeakPowerParams *params[] = {
			&combo_table[i].gpustackparams,
			&combo_table[i].gputopparams,
			&combo_table[i].bcpuparams,
			&combo_table[i].mcpuparams,
			&combo_table[i].lcpuparams,
			&combo_table[i].dsuparams };
		static const char * const part_names[] = {
			"gs",
			"gt",
			"cb",
			"cm",
			"cl",
			"cd" };

		pp_print("    cmb %d:\n", i);
		for (int j = 0;
		     j <
		     (int)(sizeof(params)/sizeof(struct IpPeakPowerParams *));
		     j++) {
			pp_print(
				"  %-10s | %6d | %6d | %6d | %7d | %9d | %9d | %11d | %6d | %10d\n",
				part_names[j],
				params[j]->dvcsratio_permille,
				params[j]->pmiceff,
				params[j]->vol_mv,
				params[j]->leak105c_mw,
				params[j]->peakdynout_mw,
				params[j]->peaklkgout_mw,
				params[j]->peakpowerout_mw,
				params[j]->rloss_mw,
				params[j]->peakpowerin_mw);
		}
		pp_print("\n");
	}
}

void print_structure_values(void *structure_ptr, unsigned int size)
{
	unsigned short *data_ptr = (unsigned short *)structure_ptr;
	unsigned int num_values = size / sizeof(unsigned short);
	unsigned int i;
	char buffer[64] = { 0 };
	unsigned int buf_len = (unsigned int)sizeof(buffer);
	unsigned int offset = 0;

	pp_print("[CG PPT] table address = %llx , size = %u\n",
		 (unsigned long long)structure_ptr, size);

	for (i = 0; i < num_values; i++) {
		offset += snprintf(buffer + offset, buf_len - offset, "%hu ",
				   data_ptr[i]);
		if (i % 8 == 7) {
			pp_print("%s\n", buffer);
			memset(buffer, 0, buf_len);
			offset = 0;
		}
	}
	if (offset > 0)
		pp_print("%s\n", buffer);
}

